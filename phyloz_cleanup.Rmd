---
title: "phylogenize_t2d"
output: html_document
date: "2025-09-17"
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(ashr)
#------------------------------which approach is better?

#==============================APPROACH 1 -- combine result after running phylogenize:
#input:
count_2_t2d <- read.delim("~/Desktop/count_2_t2d.tab") %>% rename("X"="species_id")
count_5_t2d <- read.delim("~/Desktop/count_5_t2d_new.tab") %>% rename("X"="species_id")
count_srr_t2d <- read.delim("~/Desktop/count_srr_t2d.tab") %>% rename("X"="species_id")

#===metadata for each of the dataset:
md_2_t2d=read.delim("~/Desktop/md_2_t2d.tab")
md_5_t2d=read.delim("~/Desktop/md_5_t2d_fixed.tab")
md_srr_t2d=read.delim("~/Desktop/md_srr_t2d.tab")

#===phylogenize outputs for each dataset:
#---t2d cond:--all-results
phyloz_cond_2=read.csv("~/Desktop/phyloz_outs/all-results-t2d-2-cond.csv") %>% select(-X)
phyloz_cond_srr=read.csv("~/Desktop/phyloz_outs/all-results-t2d-srr-cond.csv") %>% select(-X)

#---met cond:
phyloz_met_5=read.csv("~/Desktop/phyloz_outs/all-results-t2d-5-met.csv")

#===check if they agree:
#for each taxon, and for genes in those taxon that are overlapped:
#--without ashr: + make plotly graph
merge_cond=inner_join(phyloz_cond_2, phyloz_cond_srr, by = c("taxon", "gene")) #!!!11k-12k genes are dropped!!!
merge_cond_split=split(merge_cond, merge_cond$taxon)
merge_cond_scatter=lapply(merge_cond_split, function(x) ggplot(x, aes(x = effect.size.x, y = effect.size.y)) +
  geom_point(color = "blue", size = 3) +
  labs(title = "effect size",
       x = "t2d_2",
       y = "t2d_srr") +
  theme_minimal())

#--with ashr:
ashr_merge_after=lapply(list(phyloz_cond_srr,
            phyloz_cond_2), function(x)
            ashr::ash.workhorse(x$effect.size,
                                x$std.err))
ash_srr=ashr_merge_after[[1]]
ash_2=ashr_merge_after[[2]]

ash2_res=cbind(phyloz_cond_2$taxon, phyloz_cond_2$gene, ash_2$result) 
colnames(ash2_res)[c(1, 2)] <- c("taxon", "gene")
ashSrr_res=cbind(phyloz_cond_srr$taxon, phyloz_cond_srr$gene, ash_srr$result)
colnames(ashSrr_res)[c(1, 2)] <- c("taxon", "gene")

#make a plot for each gene/per taxon:
merge_cond_ash=inner_join(ash2_res, ashSrr_res, by = c("taxon", "gene"))
merge_cond_ash_split=split(merge_cond_ash, merge_cond_ash$taxon)



#===combine later with fixed effect:

#==============================APPROACH 2 -- combine result before running phylogenize:
```

